======================================================================================================================
DESCRIPTION:

MB-47604: Add config for expiration from start of compaction

We can't assert that the expiries generated by each KVStore in
NexusKVStore are the same if the timepoint from which we can
expire changes as we visit each item. Add configuration such that
NexusKVStore can have items be expired from the start time of each
compaction rather than a moving time point.

Change-Id: Ida6e3382c2c30063582d2bae008a6440dfa72663
Reviewed-on: http://review.couchbase.org/c/kv_engine/+/160231
Tested-by: Build Bot <build@couchbase.com>
Reviewed-by: Jim Walker <jim@couchbase.com>

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Ben Huddleston
Date: 2021-09-02 15:28:10.000000000
Message: 
Change has been successfully cherry-picked as 72048f243b2bc7c993c2256c0eb2c3c6cbdf36ed by Ben Huddleston
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2021-09-02 15:32:59.000000000
Message: 
Patch Set 6:

Build Started http://cv.jenkins.couchbase.com/job/kv_engine-post-commit-TSan-master/5759/ (1/2)
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2021-09-02 15:40:05.000000000
Message: 
Patch Set 6:

Build Started http://cv.jenkins.couchbase.com/job/kv_engine-post-commit-master/8754/ (2/2)
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2021-09-02 16:31:40.000000000
Message: 
Patch Set 6:

Build Unstable 

http://cv.jenkins.couchbase.com/job/kv_engine-post-commit-TSan-master/5759/ : UNSTABLE

ERROR: do_warmup_100k (memcapable.WarmUpMemcachedTest)
 ( http://cv.jenkins.couchbase.com/job/kv_engine-post-commit-TSan-master/5759/ )

Failure of a testrunner test ( http://cv.jenkins.couchbase.com/job/kv_engine-post-commit-TSan-master/5759/ )

http://cv.jenkins.couchbase.com/job/kv_engine-post-commit-master/8754/ : SUCCESS'
----------------------------------------------------------------------------------------------------------------------
Author: Dave Rigby
Date: 2021-09-06 09:56:15.000000000
Message: 
Patch Set 6:

(1 comment)
Line:180, engines/ep/configuration.json -> I actually think this could just be the default behaviour and not add the complexity of maintaining two modes.

----------------------------------------------------------------------------------------------------------------------
Author: Ben Huddleston
Date: 2021-09-06 09:59:05.000000000
Message: 
Patch Set 6:

(1 comment)
Line:180, engines/ep/configuration.json -> I considered that, but I vaguely recall seeing compactions take tens of minutes for some customer buckets and figured it could have an impact there. Happy to remove the old logic or leave this in as a chicken bit and change the default

----------------------------------------------------------------------------------------------------------------------
Author: Dave Rigby
Date: 2021-09-06 10:01:16.000000000
Message: 
Patch Set 6:

(1 comment)
Line:180, engines/ep/configuration.json -> It's certainly true compaction could take minutes, but there's no guarantee what order items will be visited in so it arguably doesn't matter if some items which expire "during" compaction are not cleaned up on this run.

Given the code is now in, maybe change the default in the short-term, if it's all good then we can remove the old mode at a later date.

----------------------------------------------------------------------------------------------------------------------
Author: Ben Huddleston
Date: 2021-09-06 10:07:25.000000000
Message: 
Patch Set 6:

(1 comment)
Line:180, engines/ep/configuration.json -> http://review.couchbase.org/c/kv_engine/+/160886

----------------------------------------------------------------------------------------------------------------------
