======================================================================================================================
DESCRIPTION:

MB-24432: Store a seqno to _local to determine when a CAS is a HLC value

Add a new field to _local/vbstate called hlc_epoch, this is a seqno
which we will later use to determine if a value has a CAS that is
a HLC (as opposed to a CAS generated in 3.x).

This persisted seqno will be used in the future to determine which
items can be tagged with a last-update virtual xattr (i.e. items we
know that the CAS is HLC generated as opposed to a CAS generated by
3.x).

Change-Id: I5ef5a8a08b06e69e3160ed71524f74c3053fd59e

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Jim Walker
Date: 2017-06-14 12:45:17.000000000
Message: 
Uploaded patch set 8.
----------------------------------------------------------------------------------------------------------------------
Author: Dave Rigby
Date: 2017-06-14 12:53:21.000000000
Message: 
Patch Set 8: Code-Review-1

(4 comments)

Just a few minor comments. I think the most interesting one is the question of if we should put HlcCasEpoch into the VBucket constructor...
Line:167, engines/ep/src/kvstore.h -> Just spotted this in relation to http://review.couchbase.org/#/c/64119/2/src/couch-kvstore/couch-kvstore.cc - should we remove this also?

Line:1132, engines/ep/src/vbucket.h -> Might be overly-paranoid, but worth adding a check that input param isn't HlcCasSeqnoUninitialised and throwing invalid_argument if so?

Line:1601, engines/ep/src/vbucket.h -> Maybe be even more explicit - "... documents with sequence numbers greater or equal to this have a HLC CAS"

?

Line:813, engines/ep/src/warmup.cc -> Might be safer to make CASEpochSeqno be a constructor argument - then we cannot create a VBucket without one.

----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2017-06-14 13:09:00.000000000
Message: 
Patch Set 8: Verified-1

Build Failed 

http://cv.jenkins.couchbase.com/job/kv_engine-linux-master/560/ : FAILURE

Failure of a CTest test  2/57 MemCheck #10: ep-engine_ep_unit_tests ........................ ( http://cv.jenkins.couchbase.com//job/kv_engine-linux-master/560/ )

http://cv.jenkins.couchbase.com/job/kv_engine-addresssanitizer-master/550/ : FAILURE

AddressSanitizer issue: heap-use-after-free /home/couchbase/jenkins/workspace/kv_engine-addresssanitizer-master/kv_engine/engines/ep/src/ep_engine.cc:6126:5 in EventuallyPersistentEngine::handleDisconnect(void const*) ( http://cv.jenkins.couchbase.com//job/kv_engine-addresssanitizer-master/550/ )

Failure of a CTest test 12/82 Test #12: ep-engine_ep_unit_tests ........................ ( http://cv.jenkins.couchbase.com//job/kv_engine-addresssanitizer-master/550/ )

http://cv.jenkins.couchbase.com/job/kv_engine-threadsanitizer-master/561/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine-clang_analyzer-master/500/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine-windows-master/524/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Jim Walker
Date: 2017-06-15 10:03:14.000000000
Message: 
Patch Set 8:

(1 comment)
Line:813, engines/ep/src/warmup.cc -> agreed, the code churn though in adding VB params is a lot now :) so i shortcutted here... will update now the core stuff is working

----------------------------------------------------------------------------------------------------------------------
Author: Dave Rigby
Date: 2017-06-15 10:32:15.000000000
Message: 
Patch Set 8:

(1 comment)
Line:813, engines/ep/src/warmup.cc -> Ta

----------------------------------------------------------------------------------------------------------------------
