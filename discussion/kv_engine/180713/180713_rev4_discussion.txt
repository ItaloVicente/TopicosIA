======================================================================================================================
DESCRIPTION:

MB-46740: ActiveStream pushes max 2*checkpoint_max_size_bytes to readyQ

Before this patch the ActiveStream Task pulls all the checkpoint
outstanding items for cursor and pushes them into the Stream::readyQ.

That behaviour is the reason why the allocation in readyQ can take a
relevant chunk of the BucketQuota. High allocations in the readyQ have
been observed multiple times, eg MB-53590 as one of the most recent.

This patch changes the ActiveStream Task behaviour to limiting to
checkpoint_max_size_bytes the size of the snapshot generated by
cursor-move and pused into the readyQ.

Given that the ActiveStream frontend pulls from checkpoint only when
the readyQ is empty (ie, all ready items streamed to the DCP client),
then checkpoint_max_size_bytes is the new max size for each stream
readyQ.

The throretical upper bound is actually 2*checkpoint_max_size_bytes
though. That is because CheckpointManager moves always the DCP cursor
at checkpoint boundaries for generating consistent snapshots. Thus, in
the unlucky case were
  (a) Cursor moves to the end of its current checkpoint -> total
      total snapshot size just below checkpoint_max_size_bytes
  (b) Cursor jumps into the next checkpoint (if any) and pulls
      everything from there too
, then Task would thoretically push to the readyQ up to twice
checkpoint_max_size_bytes.

Just for making an example, in a scenario like:
  - BucketQuota = 1GB
  - checkpoint_memory_ratio = 30% of BucketQuota = 300MB
  - max_checkpoints = 10
  - num_vbuckets = 64
  - 2 nodes, 1 replica

, then before this change the allocation in the stream's readyQ(s) on a
single DCP Producer can grow up tp 300MB, as nothing's preventing the
ActiveStream Task from pulling a full CM and pushing all itemsn into
readyQ(s).

While with this change:
  - checkpoint_max_size_bytes = CMQuota / max_checkpoints /
    num_vbuckets ~ 480KB
  - single readyQ = 2 * checkpoint_max_size_bytes = 960KB
  - 32 readyQ(s) per node -> ~ 30MB

Change-Id: Id4ecee911550834d209434bbf76480f73fae32fd

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Paolo Cocchi
Date: 2022-10-03 11:41:43.000000000
Message: 
Uploaded patch set 4.
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-10-03 12:06:27.000000000
Message: 
Patch Set 4: Verified-1

Build Failed 

https://cv.jenkins.couchbase.com/job/kv_engine-windows-master/49905/ : FAILURE

Failure of GoogleTest "TransportProtocols/PauseResumeTest.PauseFailsWhenPaused/McbpSsl":

<pre>
[ RUN      ] TransportProtocols/PauseResumeTest.PauseFailsWhenPaused/McbpSsl
unknown file: error: C++ exception with description "Select bucket [default] failed: Not found (1)" thrown in the test body.
[  FAILED  ] TransportProtocols/PauseResumeTest.PauseFailsWhenPaused/McbpSsl, where GetParam() = McbpSsl (1113 ms)
TransportProtocols/PauseResumeTest.PauseFailsWhenPaused/McbpSsl
</pre>
 ( https://cv.jenkins.couchbase.com/job/kv_engine-windows-master/49905/ )

https://cv.jenkins.couchbase.com/job/kv_engine.linux/job/master/23220/ : FAILURE

Failure of GoogleTest "EphemeralOrPersistent/BucketQuotaChangeTest.QuotaChangeDownMemoryUsageHigh/persistent_magma_value_only":

<pre>
[ RUN      ] EphemeralOrPersistent/BucketQuotaChangeTest.QuotaChangeDownMemoryUsageHigh/persistent_magma_value_only
[2022-10-03T11:49:59.615Z] ../kv_engine/engines/ep/tests/module_tests/kv_bucket_test.cc:188: Failure
[2022-10-03T11:49:59.615Z] Expected: (0) != (expectedCount), actual: 0 vs 0
[2022-10-03T11:49:59.615Z] unexpected error:no memory for key:cid:0x0:diffKey
[2022-10-03T11:49:59.615Z] Google Test trace:
[2022-10-03T11:49:59.615Z] ../kv_engine/engines/ep/tests/module_tests/bucket_quota_change_test.cc:342: 
[2022-10-03T11:49:59.615Z] ../kv_engine/engines/ep/tests/module_tests/kv_bucket_test.cc:272: Failure
[2022-10-03T11:49:59.615Z] Expected equality of these values:
[2022-10-03T11:49:59.615Z]   expected
[2022-10-03T11:49:59.615Z]     Which is: 1
[2022-10-03T11:49:59.615Z]   actualFlushed
[2022-10-03T11:49:59.615Z]     Which is: 0
[2022-10-03T11:49:59.615Z] Unexpected items (0) in flush_vbucket_to_disk(vb:0, 1)
[2022-10-03T11:49:59.615Z] Google Test trace:
[2022-10-03T11:49:59.615Z] ../kv_engine/engines/ep/tests/module_tests/bucket_quota_change_test.cc:342: 
[2022-10-03T11:49:59.615Z] [  FAILED  ] EphemeralOrPersistent/BucketQuotaChangeTest.QuotaChangeDownMemoryUsageHigh/persistent_magma_value_only, where GetParam() = "bucket_type=persistent:backend=magma:item_eviction_policy=value_only" (99 ms)
EphemeralOrPersistent/BucketQuotaChangeTest.QuotaChangeDownMemoryUsageHigh/persistent_magma_value_only
</pre>
 ( https://cv.jenkins.couchbase.com/job/kv_engine.linux/job/master/23220/ )

https://cv.jenkins.couchbase.com/job/kv_engine-clang_format_9/20069/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine-clang_tidy-master/20839/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine-clang_analyzer-master/41933/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine.libFuzzer/job/master/10552/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine.aarch64-linux/job/master/10652/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/master/22824/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine.macos/job/master/22228/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/master/24063/ : SUCCESS

https://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/master/31236/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Paolo Cocchi
Date: 2022-10-03 12:22:31.000000000
Message: 
Patch Set 4: Verified+1

(1 comment)
File Comment: /PATCHSET_LEVEL -> Known/unrelated PauseResumeTest + Magma test failures
----------------------------------------------------------------------------------------------------------------------
Author: Paolo Cocchi
Date: 2022-10-03 12:22:33.000000000
Message: 
Removed Verified-1 by <GERRIT_ACCOUNT_1000011>

----------------------------------------------------------------------------------------------------------------------
