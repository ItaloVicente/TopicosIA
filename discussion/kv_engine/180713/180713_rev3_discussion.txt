======================================================================================================================
DESCRIPTION:

MB-46740: ActiveStream pushes max 2*checkpoint_max_size_bytes to readyQ

Before this patch the ActiveStream Task pulls all the checkpoint
outstanding items for cursor and pushes them into the Stream::readyQ.

That behaviour is the reason why the allocation in readyQ can take a
relevant chunk of the BucketQuota. High allocations in the readyQ have
been observed multiple times, eg MB-53590 as one of the most recent.

This patch changes the ActiveStream Task behaviour to limiting to
checkpoint_max_size_bytes the size of the snapshot generated by
cursor-move and pused into the readyQ.

Given that the ActiveStream frontend pulls from checkpoint only when
the readyQ is empty (ie, all ready items streamed to the DCP client),
then checkpoint_max_size_bytes is the new max size for each stream
readyQ.

The throretical upper bound is actually 2*checkpoint_max_size_bytes
though. That is because CheckpointManager moves always the DCP cursor
at checkpoint boundaries for generating consistent snapshots. Thus, in
the unlucky case were
  (a) Cursor moves to the end of its current checkpoint -> total
      total snapshot size just below checkpoint_max_size_bytes
  (b) Cursor jumps into the next checkpoint (if any) and pulls
      everything from there too
, then Task would thoretically push to the readyQ up to twice
checkpoint_max_size_bytes.

Just for making an example, in a scenario like:
  - BucketQuota = 1GB
  - checkpoint_memory_ratio = 30% of BucketQuota = 300MB
  - max_checkpoints = 10
  - num_vbuckets = 64
  - 2 nodes, 1 replica

, then before this change the allocation in the stream's readyQ(s) on a
single DCP Producer can grow up tp 300MB, as nothing's preventing the
ActiveStream Task from pulling a full CM and pushing all itemsn into
readyQ(s).

While with this change:
  - checkpoint_max_size_bytes = CMQuota / max_checkpoints /
    num_vbuckets ~ 480KB
  - single readyQ = 2 * checkpoint_max_size_bytes = 960KB
  - 32 readyQ(s) per node -> ~ 30MB

Change-Id: Id4ecee911550834d209434bbf76480f73fae32fd

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Paolo Cocchi
Date: 2022-10-03 11:39:59.000000000
Message: 
Uploaded patch set 3.
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-10-03 11:41:54.000000000
Message: 
Patch Set 3: Verified-1

Build Failed 

https://cv.jenkins.couchbase.com/job/kv_engine-clang_tidy-master/20838/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine-clang_tidy-master/20838/ )

https://cv.jenkins.couchbase.com/job/kv_engine-windows-master/49904/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine-windows-master/49904/ )

https://cv.jenkins.couchbase.com/job/kv_engine-clang_analyzer-master/41932/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine-clang_analyzer-master/41932/ )

https://cv.jenkins.couchbase.com/job/kv_engine.libFuzzer/job/master/10551/ : ABORTED

Clang linker error: linker command failed due to signal (use -v to see invocation) ( https://cv.jenkins.couchbase.com/job/kv_engine.libFuzzer/job/master/10551/ )

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine.libFuzzer/job/master/10551/ )

https://cv.jenkins.couchbase.com/job/kv_engine.aarch64-linux/job/master/10651/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine.aarch64-linux/job/master/10651/ )

https://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/master/22823/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/master/22823/ )

https://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/master/24062/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/master/24062/ )

https://cv.jenkins.couchbase.com/job/kv_engine.linux/job/master/23219/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine.linux/job/master/23219/ )

https://cv.jenkins.couchbase.com/job/kv_engine.macos/job/master/22227/ : ABORTED

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine.macos/job/master/22227/ )

https://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/master/31235/ : ABORTED

Clang linker error: linker command failed due to signal (use -v to see invocation) ( https://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/master/31235/ )

Build which was aborted due to a newer patch set being uploaded for the given review. ( https://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/master/31235/ )

https://cv.jenkins.couchbase.com/job/kv_engine-clang_format_9/20068/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
