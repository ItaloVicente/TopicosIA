======================================================================================================================
DESCRIPTION:

MB-46740: Limit the size of ActiveStream::readyQ

Before this patch the ActiveStream Task pulls all the checkpoint
outstanding items for cursor and pushes them into the Stream::readyQ.

That behaviour is the reason why the allocation in readyQ can take a
significant chunk of the BucketQuota. High allocations in the readyQ
have been observed multiple times, eg MB-53590 as one of the most
recent.

This patch changes the ActiveStream Task behaviour so that it tries
to limit to preferably checkpoint_max_size_bytes the size of the
snapshot generated by cursor-move and pushed into the readyQ.

The actual expected max size is (2 * checkpoint_max_size_bytes)
though.
That is because (for DCP in particular) CM needs to generate
consistent snapshots, so a DCP cursor might pull more than
checkpoint_max_size_bytes. Eg in a case were
  - Cursor moves to the end of its current checkpoint -> total
    snapshot size just below checkpoint_max_size_bytes
  - Cursor jumps into the next checkpoint (if any) and pulls
    everything from there too
, then Task would push to the readyQ up to 2 full checkpoints.

Given that the ActiveStream frontend pulls from checkpoint only when
the readyQ is empty (ie, all ready items streamed to the DCP client),
then (2 * checkpoint_max_size_bytes) is the new theretical size limit
for each stream readyQ.

Just for making an example, in a scenario like:
  - BucketQuota = 1GB
  - checkpoint_memory_ratio = 30% of BucketQuota = 300MB
  - max_checkpoints = 10
  - num_vbuckets = 64
  - 2 nodes, 1 replica

, then before this change the allocation in the stream's readyQ(s) on a
single DCP Producer can grow up tp 300MB, as nothing's preventing the
ActiveStream Task from pulling a full CM and pushing all items into
readyQ(s).

While with this change:
  - checkpoint_max_size_bytes = CMQuota / max_checkpoints /
      num_vbuckets ~ 480KB
  - single readyQ = 2 * checkpoint_max_size_bytes = 960KB
  - 32 readyQ(s) per node -> ~ 30MB in total

Change verified on tests in MB-53590 (bulk-load via restore). The
baseline runs suffer from uncapped allocations in the Stream::readyQ
that cause memcacahed continously jumping in/out TempOOM phases.
Test repetition on this change (toy run) shows the memcached mem-usage
never crossing the HWM. Result is:
  - No TempOOMs
  - Ingestion throughput gets a 3x boost
  - Overall improved memory control allows to end the test at
   ActiveRR=12% (rather than 0% at baseline)
See MB-53590 for details.

- Notes-

Why using checkpoint_max_size_bytes as theoretical limit (and not some
other quantity) ?
Checkpoint's max size is a sensible quantity as the checkpoint is the
replication queue.
Since MB-50984, that quantity is a hard limit on the single checkpoint.
Also, that scales nicely on Bucket/CM quotas.

Why not limiting the readyQ to exactly 1 checkpoint?
That is suboptimal in cases where checkpoints are closed before
reaching checkpoint_max_size_bytes (eg, SyncWrite and SystemEvent). In
those cases we might end up with checkpoints that contain just a few
items, which means that processing checkpoint_max_size_bytes would
require too many DCP loops.

Change-Id: Id4ecee911550834d209434bbf76480f73fae32fd
Reviewed-on: https://review.couchbase.org/c/kv_engine/+/180713
Reviewed-by: Dave Rigby <daver@couchbase.com>
Tested-by: Build Bot <build@couchbase.com>

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Paolo Cocchi
Date: 2022-10-04 13:57:52.000000000
Message: 
Change has been successfully cherry-picked as 274b1e455142ca09cf1ef6e681316253784f203b
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-10-04 13:58:01.000000000
Message: 
Patch Set 11:

Build Started https://cv.jenkins.couchbase.com/job/kv_engine-post-commit-TSan-master/8115/ (1/2)
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-10-04 13:58:01.000000000
Message: 
Patch Set 11:

Build Started https://cv.jenkins.couchbase.com/job/kv_engine-post-commit-master/12248/ (2/2)
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-10-04 14:08:02.000000000
Message: 
Patch Set 11:

Build Failed 

https://cv.jenkins.couchbase.com/job/kv_engine-post-commit-TSan-master/8115/ : FAILURE

CMake error: /home/couchbase/jenkins/workspace/kv_engine-post-commit-TSan-master/tlm/cmake/Modules/go-modbuild.cmake:181 (MESSAGE) ( https://cv.jenkins.couchbase.com/job/kv_engine-post-commit-TSan-master/8115/ )

https://cv.jenkins.couchbase.com/job/kv_engine-post-commit-master/12248/ : UNSTABLE

ERROR: rebalancein (unittest.loader._FailedTest)
 ( https://cv.jenkins.couchbase.com/job/kv_engine-post-commit-master/12248/ )
----------------------------------------------------------------------------------------------------------------------
