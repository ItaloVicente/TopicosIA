======================================================================================================================
DESCRIPTION:

MB-53428: Disable and handle any attempt renegotiation SSL

1) Disable OpenSSL renegotiation

This is done by adding SSL_OP_NO_RENEGOTIATION to SSL_CTX_set_options.

2) Ensure KV responds to a renegotiation attempt by checking if
SSL_read has generated a response.

With renegotiation disabled, a client can still attempt to renegotiate.
When this happens an SSL alert is generated by the server and must be
sent back to the client. This is achieved by querying the network BIO
after calling SSL_read if the WANT_READ error occurs. When write data
has been generated call the data is written back to the client and
the read retried.

2.1) Read and process SSL input until connection ends

As part of testing the renegotiation an inconsistency between
mad-hatter and cheshire-cat was noted whilst using the
'openssl s_client' for testing.

The flow of messages was observed in wireshark as follows.

client -> server: Handshake
server -> client: SSL alert, no_renegotiation
client -> server: SSL alert, no_renegotiation

I.e. the client appears to echo back the SSL alert, the openssl client
would also terminate immediately after sending the last message. KV had
a racey behaviour in that sometimes KV engine would process the incoming
alert (and reset the connection) and sometimes it would not see the
message, compared to cheshire-cat where KV would always process the
incoming alert.

This is addressed by moving the check of ssl.hasError to be always after
the sslRead function. When hasError was before the sslRead call, sometimes
we would skip processing the final bytes received from the client.

Change-Id: I5517d4558142d4b6616be86953f7261d9419593c
Reviewed-on: https://review.couchbase.org/c/kv_engine/+/179158
Reviewed-by: Trond Norbye <trond.norbye@couchbase.com>
Reviewed-by: Dave Rigby <daver@couchbase.com>
Tested-by: Build Bot <build@couchbase.com>
Well-Formed: Restriction Checker

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Jim Walker
Date: 2022-08-30 09:50:19.000000000
Message: 
Change has been successfully cherry-picked as dec107512bc9e9a1522ac21b66603620e7ba7578
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-08-30 09:50:29.000000000
Message: 
Patch Set 11:

Build Started http://cv.jenkins.couchbase.com/job/kv_engine-madhatter-post-commit/1816/
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-08-30 10:18:23.000000000
Message: 
Patch Set 11:

Build Successful 

http://cv.jenkins.couchbase.com/job/kv_engine-madhatter-post-commit/1816/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
