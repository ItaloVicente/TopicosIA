======================================================================================================================
DESCRIPTION:

MB-53428: Disable and handle any attempt renegotiation SSL

1) Disable OpenSSL renegotiation

This is done by adding SSL_OP_NO_RENEGOTIATION to SSL_CTX_set_options.

2) Ensure KV responds to a renegotiation attempt by checking if
SSL_read has generated a response.

With renegotiation disabled, a client can still attempt to renegotiate.
When this happens an SSL alert is generated by the server and must be
sent back to the client. This is achieved by querying the network BIO
after calling SSL_read if the WANT_READ error occurs. When write data
has been generated call the data is written back to the client and
the read retried.

2.1) Read and process SSL input until connection ends

As part of testing the renegotiation an inconsistency between
mad-hatter and cheshire-cat was noted whilst using the
'openssl s_client' for testing.

The flow of messages was observed in wireshark as follows.

client -> server: Handshake
server -> client: SSL alert, no_renegotiation
client -> server: SSL alert, no_renegotiation

I.e. the client appears to echo back the SSL alert, the openssl client
would also terminate immediately after sending the last message. KV had
a racey behaviour in that sometimes KV engine would process the incoming
alert (and reset the connection) and sometimes it would not see the
message, compared to cheshire-cat where KV would always process the
incoming alert.

This is addressed by moving the check of ssl.hasError to be always after
the sslRead function. When hasError was before the sslRead call, sometimes
we would skip processing the final bytes received from the client.

Change-Id: I5517d4558142d4b6616be86953f7261d9419593c

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Jim Walker
Date: 2022-08-26 15:00:19.000000000
Message: 
Uploaded patch set 10.
----------------------------------------------------------------------------------------------------------------------
Author: Restriction Checker
Date: 2022-08-26 15:00:32.000000000
Message: 
Patch Set 10: Well-Formed-1

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.couchbase.com/job/restricted-branch-check/312636/artifact/restricted.html : FAILURE
----------------------------------------------------------------------------------------------------------------------
Author: Trond Norbye
Date: 2022-08-26 15:02:17.000000000
Message: 
Patch Set 10: Code-Review+2
----------------------------------------------------------------------------------------------------------------------
Author: Dave Rigby
Date: 2022-08-26 15:09:40.000000000
Message: 
Patch Set 10: Code-Review+2

(1 comment)
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-08-26 15:20:36.000000000
Message: 
Patch Set 10: Verified+1

Build Successful 

http://cv.jenkins.couchbase.com/job/kv_engine-clang_format/26654/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine-windows-madhatter/2283/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine-clang_analyzer-mad-hatter/2042/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine.libFuzzer/job/mad-hatter/195/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/mad-hatter/1924/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine.macos/job/mad-hatter/1492/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/mad-hatter/2126/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine.linux/job/mad-hatter/2143/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/mad-hatter/2143/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Jim Walker
Date: 2022-08-30 08:20:12.000000000
Message: 
Patch Set 10:

(1 comment)
----------------------------------------------------------------------------------------------------------------------
Author: Jim Walker
Date: 2022-08-30 09:49:35.000000000
Message: 
Patch Set 10:

(1 comment)
File Comment: /PATCHSET_LEVEL -> check approval

----------------------------------------------------------------------------------------------------------------------
Author: Restriction Checker
Date: 2022-08-30 09:49:53.000000000
Message: 
Patch Set 10: Well-Formed+1

Permission granted to commit: 

http://server.jenkins.couchbase.com/job/restricted-branch-check/312906/artifact/restricted.html : SUCCESS
----------------------------------------------------------------------------------------------------------------------
