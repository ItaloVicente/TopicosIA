======================================================================================================================
DESCRIPTION:

MB-42352: allow_del_with_meta_prune_user_data true by default

Pre-6.6 versions are affected by invalid payloads generated by
expirations. Ie, body or user-xattrs in the value.
6.6.0 fixes that. But, users of DelWithMeta may still fail validation
when they want to store pre-6.6 data into a 6.6 node. Eg,
backup/restore and XDCR.

Since MB-36321 DelWithMeta can operate in a "sanitizer" mode that is off
by default. This patch enables it, so any invalid payload will be
sanitized and successfully stored in 6.6.

The feature seems to have already a decent test coverage, introduced in
http://review.couchbase.org/c/kv_engine/+/115904/ first and then
expanded in http://review.couchbase.org/c/kv_engine/+/129191.

Change-Id: I3e436bafd98d4eec9d91f34c5d45be882440d57e

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Paolo Cocchi
Date: 2020-11-03 15:49:14.000000000
Message: 
Patch Set 3: Patch Set 2 was rebased
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2020-11-03 15:49:25.000000000
Message: 
Patch Set 3:

Permission granted to commit: 

http://server.jenkins.couchbase.com/job/restricted-branch-check/208096/artifact/restricted.html : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2020-11-03 17:34:40.000000000
Message: 
Patch Set 3: Verified-1

Build Failed 

http://cv.jenkins.couchbase.com/job/kv_engine-windows-madhatter/1739/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
..\kv_engine\tests\testapp\testapp_withmeta.cc(230): error: Value of: rsp.isSuccess()
  Actual: true
Expected: false
Success
[  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (13 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine-windows-madhatter/1739/ )

Failure of a CTest test 178/181 Test #171: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine-windows-madhatter/1739/ )

http://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/mad-hatter/1653/ : FAILURE

http://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/mad-hatter/1684/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
[2020-11-03T17:13:17.645Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T17:13:17.645Z] Value of: rsp.isSuccess()
[2020-11-03T17:13:17.645Z]   Actual: true
[2020-11-03T17:13:17.645Z] Expected: false
[2020-11-03T17:13:17.645Z] Success
[2020-11-03T17:13:17.645Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (4 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/mad-hatter/1684/ )

Failure of a CTest test [2020-11-03T17:13:17.644Z]   3/187 Test #177: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/mad-hatter/1684/ )

http://cv.jenkins.couchbase.com/job/kv_engine.linux/job/mad-hatter/1680/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo
[2020-11-03T17:23:25.875Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T17:23:25.875Z] Value of: rsp.isSuccess()
[2020-11-03T17:23:25.875Z]   Actual: true
[2020-11-03T17:23:25.875Z] Expected: false
[2020-11-03T17:23:25.875Z] Success
[2020-11-03T17:23:25.875Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <01-00 00-00>) (10 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.linux/job/mad-hatter/1680/ )

Failure of a CTest test [2020-11-03T17:23:25.874Z]  32/187 Test #177: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.linux/job/mad-hatter/1680/ )

http://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/mad-hatter/1458/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
[2020-11-03T17:17:36.671Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T17:17:36.671Z] Value of: rsp.isSuccess()
[2020-11-03T17:17:36.671Z]   Actual: true
[2020-11-03T17:17:36.671Z] Expected: false
[2020-11-03T17:17:36.671Z] Success
[2020-11-03T17:17:36.671Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (16 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/mad-hatter/1458/ )

Failure of a CTest test [2020-11-03T17:17:36.670Z] 180/184 Test #174: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/mad-hatter/1458/ )

http://cv.jenkins.couchbase.com/job/kv_engine.macos/job/mad-hatter/1019/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
[2020-11-03T16:02:06.873Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T16:02:06.873Z] Value of: rsp.isSuccess()
[2020-11-03T16:02:06.873Z]   Actual: true
[2020-11-03T16:02:06.873Z] Expected: false
[2020-11-03T16:02:06.873Z] Success
[2020-11-03T16:02:06.873Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (5 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.macos/job/mad-hatter/1019/ )

Failure of a CTest test [2020-11-03T16:02:06.872Z]  31/184 Test #174: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.macos/job/mad-hatter/1019/ )

http://cv.jenkins.couchbase.com/job/kv_engine-clang_format/26145/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine-clang_analyzer-mad-hatter/1558/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2020-11-04 08:14:54.000000000
Message: 
Patch Set 3:

Build Failed 

http://cv.jenkins.couchbase.com/job/kv_engine-windows-madhatter/1739/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
..\kv_engine\tests\testapp\testapp_withmeta.cc(230): error: Value of: rsp.isSuccess()
  Actual: true
Expected: false
Success
[  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (13 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine-windows-madhatter/1739/ )

Failure of a CTest test 178/181 Test #171: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine-windows-madhatter/1739/ )

http://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/mad-hatter/1653/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
[2020-11-03T17:33:48.990Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T17:33:48.990Z] Value of: rsp.isSuccess()
[2020-11-03T17:33:48.990Z]   Actual: true
[2020-11-03T17:33:48.990Z] Expected: false
[2020-11-03T17:33:48.990Z] Success
[2020-11-03T17:33:48.990Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (21 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/mad-hatter/1653/ )

Failure of a CTest test [2020-11-03T17:33:48.989Z] 179/186 Test #176: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.ASan-UBSan/job/mad-hatter/1653/ )

http://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/mad-hatter/1684/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
[2020-11-03T17:13:17.645Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T17:13:17.645Z] Value of: rsp.isSuccess()
[2020-11-03T17:13:17.645Z]   Actual: true
[2020-11-03T17:13:17.645Z] Expected: false
[2020-11-03T17:13:17.645Z] Success
[2020-11-03T17:13:17.645Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (4 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/mad-hatter/1684/ )

Failure of a CTest test [2020-11-03T17:13:17.644Z]   3/187 Test #177: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.linux-CE/job/mad-hatter/1684/ )

http://cv.jenkins.couchbase.com/job/kv_engine.linux/job/mad-hatter/1680/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo
[2020-11-03T17:23:25.875Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T17:23:25.875Z] Value of: rsp.isSuccess()
[2020-11-03T17:23:25.875Z]   Actual: true
[2020-11-03T17:23:25.875Z] Expected: false
[2020-11-03T17:23:25.875Z] Success
[2020-11-03T17:23:25.875Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <01-00 00-00>) (10 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyNo
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.linux/job/mad-hatter/1680/ )

Failure of a CTest test [2020-11-03T17:23:25.874Z]  32/187 Test #177: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.linux/job/mad-hatter/1680/ )

http://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/mad-hatter/1458/ : FAILURE

Failure of GoogleTest "TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes":

<pre>
[ RUN      ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
[2020-11-03T17:17:36.671Z] ../kv_engine/tests/testapp/testapp_withmeta.cc:230: Failure
[2020-11-03T17:17:36.671Z] Value of: rsp.isSuccess()
[2020-11-03T17:17:36.671Z]   Actual: true
[2020-11-03T17:17:36.671Z] Expected: false
[2020-11-03T17:17:36.671Z] Success
[2020-11-03T17:17:36.671Z] [  FAILED  ] TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes, where GetParam() = (Mcbp, XattrYes, 4-byte object <00-00 00-00>, 4-byte object <00-00 00-00>) (16 ms)
TransportProtocols/WithMetaTest.MB36321_DeleteWithMetaRefuseUserXattrs/Mcbp_XattrYes_JsonYes_SnappyYes
</pre>
 ( http://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/mad-hatter/1458/ )

Failure of a CTest test [2020-11-03T17:17:36.670Z] 180/184 Test #174: memcached_testapp.ep.TransportProtocols/WithMetaTest ......................... ( http://cv.jenkins.couchbase.com/job/kv_engine.threadsanitizer/job/mad-hatter/1458/ )

http://cv.jenkins.couchbase.com/job/kv_engine.macos/job/mad-hatter/1021/ : FAILURE

http://cv.jenkins.couchbase.com/job/kv_engine-clang_format/26145/ : SUCCESS

http://cv.jenkins.couchbase.com/job/kv_engine-clang_analyzer-mad-hatter/1558/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
