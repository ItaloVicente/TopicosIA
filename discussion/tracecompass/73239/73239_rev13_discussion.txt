======================================================================================================================
DESCRIPTION:

analysis.lami: correctly handle Number (double, long etc.) type graphing

LTTng analysis return mostly long values either for the time stamps or
actual measurements. SWTChart, on the other hand, deals only with
"double" numerical values. Casting long to double causes a loss of
precision for big long value (e.g time stamps).

E.g: Loss of precision occurs when time ranges with a big minimal value
(2^62) but with little delta (1 ns) between events exist. Graphs
generated from such time ranges as an axis would result in a single dot
which is a clear problem.

The presented solution uses linear mapping to preserve resolution and
precision when possible.

The linear mapping requires two ranges: the internal range and the
external range.

Each graph is responsible to provide an internal LamiGraphRange. This
range is the internal representation in double in which all raw
(external) value are to be mapped. For now the default internal range is
0 to 1.

The external range [raw values range] is generated by finding the
minimal value and maximal values of aspects to be plotted.

Each point is then mapped to a corresponding value from the internal
range:

eV = external value
eR = external range
iV = internal value
iR = internal range

iV = (( eV - eR.minimum ) * ( iR.delta / eR.delta )) + iR.minimum

Since the default internal range is from 0 to 1 all raw values are
mapped to a value from 0 to 1.

On graph tick generation axis formatter transforms internal
representation to external representation and formats the result.

Other change:
- Aspects now return their numerical values via resolveNumber to ensure
  no casting is done.
- Move axis formatter to ui plugin.

Bug: 493941

Change-Id: I289180e10a7f1cbf6ecdd1beba93549b8fbe4c23
Signed-off-by: Jonathan Rajotte <jonathan.rajotte-julien@efficios.com>

======================================================================================================================
COMMENTS
======================================================================================================================
Author: CI Bot
Date: 2016-05-30 18:13:21.000000000
Message: 
Patch Set 13:

Build Started https://hudson.eclipse.org/tracecompass/job/tracecompass-gerrit/8721/
----------------------------------------------------------------------------------------------------------------------
Author: CI Bot
Date: 2016-05-30 18:56:04.000000000
Message: 
Patch Set 13: Code-Review+1

Build Successful 

https://hudson.eclipse.org/tracecompass/job/tracecompass-gerrit/8721/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Patrick Tasse
Date: 2016-05-30 19:08:41.000000000
Message: 
Patch Set 13: Code-Review+1 Verified+1
----------------------------------------------------------------------------------------------------------------------
Author: Jonathan Rajotte Julien
Date: 2016-05-31 14:07:54.000000000
Message: 
Patch Set 13:

Alexmonthy is looking at the patch and should give some comments soon and we will go from there regarding merging.

Thanks Patrick for the review!
----------------------------------------------------------------------------------------------------------------------
Author: Alexandre Montplaisir
Date: 2016-05-31 19:28:35.000000000
Message: 
Patch Set 13: Code-Review-1

(9 comments)

Few comments on style. I'll test it next.
Line:129, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/format/LamiDecimalUnitFormat.java -> when doing elvis-checks directly in return statements, I normally suggest to add parentheses around it:

  return (buffer == null ? new StringBuffer() : buffer);

or else it's easy to parse the line as

  return buffer ...

and stop reading, while in some cases what is being returned may not be "buffer" at all!

Line:249, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiBarChartViewer.java -> fiddles

Don't we have this exact same comment block elsewhere? It was fixed in the version in master, you could copy-pasted that one.

Line:21, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiGraphRange.java -> add an empty line below the declaration before the first field

Line:219, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiScatterViewer.java -> put each stream operation on a separate line, it makes it much more readable.

  bla.getEntries.stream()
      .map(...)
      .collect(...)

Line:220, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiScatterViewer.java -> If you are going to just iterate on the collected List, you could avoid the intermediate list and remain in the stream operation by doing a forEach().

I'd redo this part here to be more similar to the one below:

            if (xAspect.isContinuous()) {
                xDoubleSeries = getResultTable().getEntries().stream()
                        .map(entry -> {
                            Number number = xAspect.resolveNumber(entry);
                            if (number != null && fXExternalRange != null) {
                                return getInternalDoubleValue(number, fXInternalRange, fXExternalRange);
                            }
                            return null;
                        })
                        .collect(Collectors.toList());
            } else {
                xDoubleSeries = getResultTable().getEntries().stream()
                        .map(entry -> {
                            String string = xAspect.resolveString(entry);
                            Integer value = xMap.get(string);
                            if (value != null) {
                                return Double.valueOf(value.doubleValue());
                            }
                            return null;
                        })
                        .collect(Collectors.toList());
            }

If you'd like I can do this change separately, there is another block of existing code below that could be updated to this form.

Line:67, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiXYChartViewer.java -> Private fields should be defined after public ones. It should go:

  public static final
  protected static final
  private static final
  private final
  private

Also it's not immediately obvious what BIG_DECIMAL_DIVISION_SCALE refers to. Even though it's not mandatory for private fields, you could add Javadoc here explaining a bit what it is for.

Line:78, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiXYChartViewer.java -> A Javadoc-type comments applies to the definition immediately following it only.

Now it gives a warning for ZERO_DOUBLE, which is protected but has no javadoc.

You could do

  /** Zero long value */
  protected static final long ZERO_LONG = 0L;
  /** Zero double value */
  protected static final double ZERO_DOUBLE = 0.0;

Note long should be "0L", "0" refers to an integer literal.

Line:407, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiXYChartViewer.java -> space after (cast)

  ((LamiTimeStampFormat) formatter)

auto-formatter (ctrl+shift+f) should fix it.

Line:775, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiXYChartViewer.java -> There's a BigDecimal.ONE !

Even if there wasn't, it could have been extracted into a constant.

----------------------------------------------------------------------------------------------------------------------
Author: Alexandre Montplaisir
Date: 2016-05-31 19:50:04.000000000
Message: 
Patch Set 13:

(1 comment)
Line:220, analysis/org.eclipse.tracecompass.analysis.lami.ui/src/org/eclipse/tracecompass/internal/provisional/analysis/lami/ui/viewers/LamiScatterViewer.java -> oops that's the block for the xDoubleSeries, that's above. But you get the idea ;)

----------------------------------------------------------------------------------------------------------------------
Author: Gerrit Code Review
Date: 2016-05-31 22:54:06.000000000
Message: 
Change has been successfully cherry-picked as 5b973e7c65f168e79139fdc0045dda56ff71f650 by Alexandre Montplaisir
----------------------------------------------------------------------------------------------------------------------
