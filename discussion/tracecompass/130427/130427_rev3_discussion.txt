======================================================================================================================
DESCRIPTION:

xml.core: Fix pattern analysis segment store never written on disk

Change-Id: Ic2524e108e5e78f5388e931ec55e8b37487b5cec
Signed-off-by: Jean-Christian Kouame <jean-christian.kouame@ericsson.com>
======================================================================================================================
COMMENTS
======================================================================================================================
Author: Jean-Christian Kouame
Date: 2018-10-05 14:00:10.000000000
Message: 
Uploaded patch set 3.
----------------------------------------------------------------------------------------------------------------------
Author: CI Bot
Date: 2018-10-05 14:00:28.000000000
Message: 
Patch Set 3:

Build Started https://hudson.eclipse.org/tracecompass/job/tracecompass-gerrit/19927/
----------------------------------------------------------------------------------------------------------------------
Author: Jean-Christian Kouame
Date: 2018-10-05 14:02:28.000000000
Message: 
Patch Set 3:

There is still a last part missing (should be new change). We currently waiting until the segment store is complete (analysis done) to write it on disk. This leads to important memory issues.
----------------------------------------------------------------------------------------------------------------------
Author: CI Bot
Date: 2018-10-05 15:02:43.000000000
Message: 
Patch Set 3: Verified-1

Build Failed 

https://hudson.eclipse.org/tracecompass/job/tracecompass-gerrit/19927/ : FAILURE
----------------------------------------------------------------------------------------------------------------------
Author: Genevieve Bastien
Date: 2018-10-05 16:41:51.000000000
Message: 
Patch Set 3:

With a HT segment store, it shouldn't wait, like the state system, it saves to disk as soon as a block is complete, so... maybe there's a bug somewhere else
----------------------------------------------------------------------------------------------------------------------
Author: Genevieve Bastien
Date: 2018-10-05 16:43:01.000000000
Message: 
Patch Set 3: Code-Review-1

(1 comment)
Line:40, tmf/org.eclipse.tracecompass.tmf.analysis.xml.core/src/org/eclipse/tracecompass/internal/tmf/analysis/xml/core/pattern/stateprovider/XmlPatternSegmentStoreModule.java -> This should not be, it should use the segment store from the base analysis

----------------------------------------------------------------------------------------------------------------------
Author: Genevieve Bastien
Date: 2018-10-05 16:47:36.000000000
Message: 
Patch Set 3:

(2 comments)
Line:57, tmf/org.eclipse.tracecompass.tmf.analysis.xml.core/src/org/eclipse/tracecompass/internal/tmf/analysis/xml/core/pattern/stateprovider/XmlPatternSegmentStoreModule.java -> Take this segment store here and assign it to fSegments, so that the real segment store will be filled.

Line:119, tmf/org.eclipse.tracecompass.tmf.analysis.xml.core/src/org/eclipse/tracecompass/internal/tmf/analysis/xml/core/pattern/stateprovider/XmlPatternSegmentStoreModule.java -> Here, getSegments would be @Nullable (but should not be null when here, if so, put a warning) and will return the real segment store.

----------------------------------------------------------------------------------------------------------------------
Author: Jean-Christian Kouame
Date: 2018-10-05 17:04:30.000000000
Message: 
Patch Set 3:

(3 comments)
Line:40, tmf/org.eclipse.tracecompass.tmf.analysis.xml.core/src/org/eclipse/tracecompass/internal/tmf/analysis/xml/core/pattern/stateprovider/XmlPatternSegmentStoreModule.java -> yup that's the issue i discovered. but we need this. so i edited OnNewSegment()

Line:57, tmf/org.eclipse.tracecompass.tmf.analysis.xml.core/src/org/eclipse/tracecompass/internal/tmf/analysis/xml/core/pattern/stateprovider/XmlPatternSegmentStoreModule.java -> can't do that directly because fSegment is used to get earlier segments that could be generated by the "state system analysis" before the segment store analysis here started.
i will push my work around and you will see if it fixes all of this

Line:119, tmf/org.eclipse.tracecompass.tmf.analysis.xml.core/src/org/eclipse/tracecompass/internal/tmf/analysis/xml/core/pattern/stateprovider/XmlPatternSegmentStoreModule.java -> i did add this here, and it seems working well so far

if (fFinalSegments == null) {
                getSegments().add(segment);
            } else {
                if (!getSegments().isEmpty()) {
                    fFinalSegments.addAll(getSegments());
                    getSegments().clear();
                }
                fFinalSegments.add(segment);
            }

----------------------------------------------------------------------------------------------------------------------
Author: Jean-Christian Kouame
Date: 2018-10-05 20:38:21.000000000
Message: 
Topic set to xml_improvement
----------------------------------------------------------------------------------------------------------------------
