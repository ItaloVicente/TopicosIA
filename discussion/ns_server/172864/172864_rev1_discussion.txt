======================================================================================================================
DESCRIPTION:

MB-51602: Filter out tls options that are not supported by tls1.3

... when min tls version is set to tls 1.3

Change-Id: Iac1a055de05dda765b3800e52e0f3c4c91bab203

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Timofey Barmin
Date: 2022-03-25 22:26:42.000000000
Message: 
Uploaded patch set 1.
----------------------------------------------------------------------------------------------------------------------
Author: Restriction Checker
Date: 2022-03-25 22:26:53.000000000
Message: 
Patch Set 1: Well-Formed+1

Permission granted to commit: 

http://server.jenkins.couchbase.com/job/restricted-branch-check/292732/artifact/restricted.html : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-03-25 22:26:55.000000000
Message: 
Patch Set 1:

Build Started http://cv.jenkins.couchbase.com/job/ns-server-test/29941/
----------------------------------------------------------------------------------------------------------------------
Author: Timofey Barmin
Date: 2022-03-25 22:27:13.000000000
Message: 
Patch Set 1:

(1 comment)
File Comment: /PATCHSET_LEVEL -> make simple-test
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-03-25 22:27:42.000000000
Message: 
Patch Set 1:

Build Started http://cv.jenkins.couchbase.com/job/ns-server-neo-simple-test/13/
----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-03-25 22:31:48.000000000
Message: 
Patch Set 1: Well-Formed+1

Build Successful 

http://cv.jenkins.couchbase.com/job/ns-server-test/29941/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Bryan McCoid
Date: 2022-03-25 22:46:21.000000000
Message: 
Patch Set 1: Code-Review+2

(1 comment)
File Comment: /PATCHSET_LEVEL -> Looks good. I tested it with:

$ curl -u Administrator:asdasd 127.0.0.1:9000/settings/security -X POST  -H 'Content-Type: application/binary' -d 'clusterManager.tlsMinVersion=tlsv1.3&'

and even verified with redbug that we are removing the correct options:

(n_0@127.0.0.1)3> redbug:start("ns_ssl_services_setup:ssl_server_opts->stack,return", [{max_msg_size, 20000000}, {msgs, 10000}]).
{760,1}

% 15:42:56 <0.25114.1>({supervisor,menelaus_web,1})
% ns_ssl_services_setup:ssl_server_opts()
%   menelaus_web:generate_http_server_options/1
%   menelaus_web:maybe_start_http_server/2
%   supervisor:do_start_child_i/3
%   supervisor:do_start_child/2
%   supervisor:'-start_children/2-fun-0-'/3
%   supervisor:children_map/4
%   supervisor:init_children/2
%   gen_server:init_it/2
%   gen_server:init_it/6
%   proc_lib:init_p_do_apply/3

% 15:42:56 <0.25114.1>({supervisor,menelaus_web,1})
% ns_ssl_services_setup:ssl_server_opts/0 -> [{keyfile,
                                               "/Users/bryanmccoid/dev/workspace/master/ns_server/data/n_0/config/certs/pkey.pem"},
                                              {certfile,
                                               "/Users/bryanmccoid/dev/workspace/master/ns_server/data/n_0/config/certs/chain.pem"},
                                              {versions,['tlsv1.3']},
                                              {cacerts,
                                               [<<48,130,3,2,48,130,1,234,
                                                  160,3,2,1,2,2,8,22,223,192,
                                                  198,198,15,155,32,48,13,6,
                                                  9,42,134,72,134,247,13,1,1,
                                                  11,5,0,48,36,49,34,48,32,6,
                                                  3,85,4,3,19,25,67,111,117,
                                                  99,104,98,97,115,101,32,83,
                                                  101,114,118,101,114,32,55,
                                                  48,57,101,50,51,51,53,48,
                                                  30,23,13,49,51,48,49,48,49,
                                                  48,48,48,48,48,48,90,23,13,
                                                  52,57,49,50,51,49,50,51,53,
                                                  57,53,57,90,48,36,49,34,48,
                                                  32,6,3,85,4,3,19,25,67,111,
                                                  117,99,104,98,97,115,101,
                                                  32,83,101,114,118,101,114,
                                                  32,55,48,57,101,50,51,51,
                                                  53,48,130,1,34,48,13,6,9,
                                                  42,134,72,134,247,13,1,1,1,
                                                  5,0,3,130,1,15,0,48,130,1,
                                                  10,2,130,1,1,0,167,6,26,24,
                                                  77,40,72,77,210,35,208,211,
                                                  142,18,178,107,250,159,247,
                                                  181,154,6,148,245,46,32,
                                                  200,51,146,165,7,117,13,76,
                                                  245,211,101,241,157,123,31,
                                                  37,151,118,204,64,142,102,
                                                  217,167,168,128,57,252,28,
                                                  20,33,67,79,224,244,85,43,
                                                  89,7,208,140,255,189,164,
                                                  210,2,184,211,160,26,187,
                                                  248,68,42,220,18,156,243,
                                                  139,143,10,120,248,136,129,
                                                  124,26,23,123,194,232,172,
                                                  80,70,112,36,241,105,202,
                                                  66,188,163,58,102,246,102,
                                                  222,221,77,1,139,252,241,
                                                  120,241,229,28,169,208,123,
                                                  149,60,206,109,87,200,171,
                                                  4,138,210,53,192,80,35,13,
                                                  224,21,3,176,70,216,176,
                                                  239,160,249,162,235,196,65,
                                                  28,62,251,226,40,161,98,0,
                                                  147,31,123,25,216,101,174,
                                                  10,164,200,57,138,190,50,
                                                  248,150,217,213,48,61,12,
                                                  189,89,102,64,23,232,138,
                                                  105,221,54,37,100,217,20,
                                                  204,57,91,93,179,250,120,
                                                  229,165,203,215,139,198,
                                                  179,114,184,202,43,61,60,
                                                  252,158,221,42,88,30,129,
                                                  152,152,82,233,138,222,205,
                                                  179,107,237,128,154,72,32,
                                                  90,18,108,255,43,175,177,
                                                  104,60,253,174,19,170,22,
                                                  121,94,191,2,3,1,0,1,163,
                                                  56,48,54,48,14,6,3,85,29,
                                                  15,1,1,255,4,4,3,2,2,164,
                                                  48,19,6,3,85,29,37,4,12,48,
                                                  10,6,8,43,6,1,5,5,7,3,1,48,
                                                  15,6,3,85,29,19,1,1,255,4,
                                                  5,48,3,1,1,255,48,13,6,9,
                                                  42,134,72,134,247,13,1,1,
                                                  11,5,0,3,130,1,1,0,112,226,
                                                  184,1,54,7,59,165,33,127,
                                                  165,60,72,181,187,94,99,
                                                  106,175,73,218,241,87,113,
                                                  194,75,82,126,83,20,252,
                                                  130,9,95,205,209,149,44,92,
                                                  73,46,111,154,116,50,193,
                                                  187,149,30,247,69,215,124,
                                                  44,187,179,102,157,87,118,
                                                  76,224,83,255,77,245,189,
                                                  239,192,204,75,40,198,18,
                                                  163,69,16,13,163,41,84,230,
                                                  92,157,224,119,221,162,20,
                                                  74,11,183,215,71,65,190,
                                                  173,160,165,106,156,212,
                                                  100,254,150,199,144,59,150,
                                                  197,128,77,34,73,93,221,
                                                  203,192,240,36,243,55,142,
                                                  220,48,94,202,252,99,191,
                                                  117,31,32,43,36,247,191,59,
                                                  235,120,19,100,212,113,254,
                                                  255,25,247,251,63,238,122,
                                                  238,104,68,51,94,34,219,
                                                  229,126,159,242,242,65,79,
                                                  49,166,94,205,153,62,32,22,
                                                  168,162,212,3,242,216,110,
                                                  219,250,158,165,84,57,163,
                                                  34,70,218,10,229,237,147,
                                                  26,186,194,69,0,60,158,210,
                                                  245,18,148,86,181,183,97,
                                                  93,48,81,55,195,42,76,165,
                                                  35,229,90,180,101,121,238,
                                                  42,217,12,62,181,67,97,31,
                                                  14,251,228,4,96,16,21,235,
                                                  198,157,235,28,136,27,126,
                                                  232,73,249,192,219,44,122,
                                                  239>>]},
                                              {dh,
                                               <<48,130,1,8,2,130,1,1,0,152,
                                                 202,99,248,92,201,35,238,246,
                                                 5,77,93,120,10,118,129,36,52,
                                                 111,193,167,220,49,229,106,
                                                 105,152,133,121,157,73,158,
                                                 232,153,197,197,21,171,140,
                                                 30,207,52,165,45,8,221,162,
                                                 21,199,183,66,211,247,51,224,
                                                 102,214,190,130,96,253,218,
                                                 193,35,43,139,145,89,200,250,
                                                 145,92,50,80,134,135,188,205,
                                                 254,148,122,136,237,220,186,
                                                 147,187,104,159,36,147,217,
                                                 117,74,35,163,145,249,175,
                                                 242,18,221,124,54,140,16,246,
                                                 169,84,252,45,47,99,136,30,
                                                 60,189,203,61,86,225,117,255,
                                                 4,91,46,110,167,173,106,51,
                                                 65,10,248,94,225,223,73,40,
                                                 232,140,26,11,67,170,118,190,
                                                 67,31,127,233,39,68,88,132,
                                                 171,224,62,187,207,160,189,
                                                 209,101,74,8,205,174,146,173,
                                                 80,105,144,246,25,153,86,36,
                                                 24,178,163,64,202,221,95,184,
                                                 110,244,32,226,217,34,55,188,
                                                 230,55,16,216,247,173,246,
                                                 139,76,187,66,211,159,17,46,
                                                 20,18,48,80,27,250,96,189,29,
                                                 214,234,241,34,69,254,147,
                                                 103,220,133,40,164,84,8,44,
                                                 241,61,164,151,9,135,41,60,
                                                 75,4,202,133,173,72,6,69,167,
                                                 89,112,174,40,229,171,2,1,2>>},
                                              {ciphers,
                                               [{any,aes_256_gcm,aead,sha384},
                                                {any,aes_128_gcm,aead,sha256},
                                                {any,chacha20_poly1305,aead,
                                                 sha256},
                                                {any,aes_128_ccm,aead,sha256},
                                                {any,aes_128_ccm_8,aead,
                                                 sha256},
                                                {ecdhe_ecdsa,aes_256_gcm,
                                                 aead,sha384},
                                                {ecdhe_rsa,aes_256_gcm,aead,
                                                 sha384},
                                                {ecdhe_ecdsa,aes_256_ccm,aead},
                                                {ecdhe_ecdsa,aes_256_ccm_8,
                                                 aead},
                                                {ecdhe_ecdsa,
                                                 chacha20_poly1305,aead,
                                                 sha256},
                                                {ecdhe_rsa,chacha20_poly1305,
                                                 aead,sha256},
                                                {ecdhe_ecdsa,aes_128_gcm,
                                                 aead,sha256},
                                                {ecdhe_rsa,aes_128_gcm,aead,
                                                 sha256},
                                                {ecdhe_ecdsa,aes_128_ccm,aead},
                                                {ecdhe_ecdsa,aes_128_ccm_8,
                                                 aead},
                                                {ecdh_ecdsa,aes_256_gcm,aead,
                                                 sha384},
                                                {ecdh_rsa,aes_256_gcm,aead,
                                                 sha384},
                                                {ecdh_ecdsa,aes_128_gcm,aead,
                                                 sha256},
                                                {ecdh_rsa,aes_128_gcm,aead,
                                                 sha256},
                                                {dhe_rsa,aes_256_gcm,aead,
                                                 sha384},
                                                {dhe_dss,aes_256_gcm,aead,
                                                 sha384},
                                                {dhe_rsa,aes_128_gcm,aead,
                                                 sha256},
                                                {dhe_dss,aes_128_gcm,aead,
                                                 sha256},
                                                {dhe_rsa,chacha20_poly1305,
                                                 aead,sha256},
                                                {rsa_psk,aes_256_gcm,aead,
                                                 sha384},
                                                {rsa_psk,aes_128_gcm,aead,
                                                 sha256},
                                                {rsa,aes_256_gcm,aead,sha384},
                                                {rsa,aes_128_gcm,aead,
                                                 sha256}]},
                                              {honor_cipher_order,true},
                                              {password,undefined}]

The code looks good. 

----------------------------------------------------------------------------------------------------------------------
Author: Build Bot
Date: 2022-03-25 23:09:15.000000000
Message: 
Patch Set 1: Verified+1

Build Successful 

http://cv.jenkins.couchbase.com/job/ns-server-neo-simple-test/13/ : SUCCESS
----------------------------------------------------------------------------------------------------------------------
Author: Timofey Barmin
Date: 2022-03-25 23:28:39.000000000
Message: 
Patch Set 1: Verified+1
----------------------------------------------------------------------------------------------------------------------
