======================================================================================================================
DESCRIPTION:

MB-42008 set meta in projector

Change-Id: I56b7e58072ca47015ab6ce778f620770004eabca

======================================================================================================================
COMMENTS
======================================================================================================================
Author: Marco Greco
Date: 2020-10-13 11:01:58.000000000
Message: 
Uploaded patch set 1.
----------------------------------------------------------------------------------------------------------------------
Author: VarunVelamuri
Date: 2020-10-13 14:32:26.000000000
Message: 
Patch Set 1:

(1 comment)
Line:571, secondary/protobuf/projector/index.go -> Hi Marco,  Does docval.NewMeta() initialise a new meta map for every iteration? The idea of using a cached map of meta was to reduce the amount of garbage generated by projector as this call happens for every mutation. After the evaluation is done, as we discard docValue, the next mutation can safely use the cached meta

----------------------------------------------------------------------------------------------------------------------
Author: Marco Greco
Date: 2020-10-13 15:26:37.000000000
Message: 
Patch Set 1:

(1 comment)
Line:571, secondary/protobuf/projector/index.go -> Hi Varun - I get exactly what happens here, except that query has a similar problem and we need to cache meta and attachments ourselves.
So value.NewAnnotatedValue() now gives you a pooled annotated value with a pooled attachments and metas, ie we cache meta for you.
But that means that if you set up meta the old way, as an attachment, all indexes on any meta value don't work (since meta is now stored independently), hence the change to the new way.

----------------------------------------------------------------------------------------------------------------------
Author: Marco Greco
Date: 2020-10-13 16:11:48.000000000
Message: 
Patch Set 1:

(1 comment)

Verun -
Line:331, secondary/protobuf/projector/index.go -> In order to improve with GC load, you may try and use CopyAnnotations() here rather than ShareAnnotations().
Use the method that gives you the least GC load.

----------------------------------------------------------------------------------------------------------------------
Author: VarunVelamuri
Date: 2020-10-13 16:44:20.000000000
Message: 
Patch Set 1:

(1 comment)
Line:331, secondary/protobuf/projector/index.go -> Hi Marco, Thanks for the suggestion. This code won't be executed now. This code was meant to handle the case where DCP starts sending old values on a document update - I don't think KV would do this. But, I will change this (or) atleast add a comment - incase something good turns out in that space in future

----------------------------------------------------------------------------------------------------------------------
